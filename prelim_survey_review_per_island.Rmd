---
title: "Exploratory figures for CNHS"
author: "Kelvin Gorospe and Jessica Gephart"
date: "6/10/2020"
output: pdf_document
---


Notes for Mike:

* Is it correct to remove the 0/1 columns in the market Survey data?
* Is there a way to automate this process on your end? So that code still works with new data
* Where is the market availability data that we had in the last iteration?
* [name of product]_roster is the availability data
* What is the meaning of NA in the multiselect variable columns?
* "." and ".a" in STATA both mean missing. Refer to Mike's May 27 email for example (and to check for consistency with R)
* Why does VRS have household info and anemia info?
* Why are these output as different files (vrs, market, etc. each broken into multiple separate files)
* It is easiest to have the fewest number possible
* Are they going to translate the HIES iKiribati responses?
* Variable labels are cut off (how do we get the full answers back?) see: var_labels
* How to standardize units when none is given (e.g., question == Travel time outside boundary in outsideRoster dataset includes "12", "3", "30 minutes", "1 hour", etc)
* Is a response of "zero" the same as blank response? 
* What's the difference between interview__key and interview__id? Currently using both to join eventRoster, fishRoster, etc with vrs data to get island information

Suggested path forward:
 
1. Write out tidy versions of each data set and share csv
2. Write functions to visualize each question type:
     - Multi- and single-select, produce bar chart
     - Integer, produce bar chart
     - Continuous, produce histogram and (TBD: box and whisker)
     - Free response, compile unique answers with unique IDs for translation, question, island, possibly role
3. Loop through data and produce pdf of all plots
4. TBD: Start to creat summaries by village/island
 


```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(haven)
library(tidyverse)
library(magrittr)
library(ggplot2)

#___________________________________________________________________________________________#
# Read in dta files
#___________________________________________________________________________________________#
datadir <- file.path(getwd(), "Data", "HIES_raw_19May20")
outdir <- file.path(getwd(), "Outputs")

source("R_scripts/cleaning_functions.R")
source("R_scripts/plotting_functions.R")

```

## Fisheries data
### *Note: no island information in current dataset


```{r, warning = FALSE}

# FIX IT - if island information becomes available for fisheries data, will also need to incorporate p903r and p922.dta files (in Fisheries data folder): just copy code from prelim_survey_review.Rmd

#___________________________________________________________________________________________#
# Clean fisheries data
#___________________________________________________________________________________________#
fisheries <- read_dta(file.path(datadir, "Fisheries", "Fisheries.dta"))

fisheries <- clean_data(fisheries)[[1]]

# Extract variable label attributes
var_labels <- clean_data(fisheries)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fisheriesTidy <- tidy_data(df = fisheries, pivot_col_1 = "sex", pivot_col_last = "p922n3", var_labels = var_labels, question_no = TRUE) # question_no = TRUE applies to fisheries data where col.labels includes a third column for question.no

write.csv(fisheriesTidy, "Outputs/fisheriesTidy.csv", row.names = FALSE)

# Output QUESTION list:
write.csv(unique(fisheriesTidy$question), "outputs/fisheries_question_list.csv", row.names = FALSE)

```



```{r, fig.height = 8, fig.width = 8, results = 'asis'}
#___________________________________________________________________________________________#
# Visualize fisheries data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- fisheriesTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")

plot_multi_response(plotDF_multiselect)

```


## Fisheries continued...
### *Single response questions*



```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

# List short-answer, fill-in response questions here:
fill_in_questions <- c("p903n", "p921n", "p922n1", "p922n2")

# Plot histogram for each single response question while removing zeroes
plotDF_single <- fisheriesTidy %>%
  filter(is.na(option)) %>%
  filter(question.no %in% fill_in_questions == FALSE) # remove "other" responses

plot_single_response(plotDF_single, bin_n = 20)
  

# Output short answer responses for translation
other_answers <- fisheriesTidy %>% 
  filter(question.no %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/fisheries_other_answers.csv", row.names = FALSE)




```

## VRS Data
### *Multi-response questions*



```{r, warning=FALSE, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Clean VRS data
#___________________________________________________________________________________________#
vrs <- read_dta(file.path(datadir, "VRS", "VRS.dta"))

vrs <- clean_data(vrs)[[1]]

# Extract variable label attributes
var_labels <- clean_data(vrs)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
vrsTidy <- tidy_data(df = vrs, pivot_col_1 = "ms_island", pivot_col_last = "assignment__id", var_labels = var_labels, question_no = FALSE)

write.csv(vrsTidy, "Outputs/vrsTidy.csv", row.names = FALSE)

# Output question list
write.csv(unique(vrsTidy$question), "outputs/vrs_question_list.csv", row.names = FALSE)

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- vrsTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")


plot_multi_response(plotDF_multiselect, incl_island = TRUE)

```

## VRS continued...
### *Single response questions*


```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
# Plot histogram for each single response question while removing zeroes

# List short-answer, fill-in response questions here:
fill_in_questions <- vrsTidy %>%
  filter(str_detect(question, pattern = "Other") & question != "Other meeting restrictions") %>% 
  pull(question) %>% 
  unique()

# Additional fill-in response questions:
fill_in_questions <- c(fill_in_questions, "Gender attending meeting", "New village rules")

# FIX IT - confirm: assuming zero is different from "blank" (plotting function reports number of zeroes removed)
plotDF_single <- vrsTidy %>%
  filter(is.na(option)) %>%
  filter(question %in% fill_in_questions == FALSE)  %>% # remove all short answer questions 
  filter(response != "") %>% # If first response in a question set is blank, function plot_single_response does not work
  filter(question %in% c("VRS Village", "Household ID", "Start Time and Date for VRS section", "End Time and Date for VRS section",
                         "Errors count in the interview", "Status of the interview")==FALSE) # FIX IT - confirm: remove these too?

plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


# Output short answer responses for translation
other_answers <- vrsTidy %>% 
  filter(question %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/vrs_other_answers.csv", row.names = FALSE)

# Output sample sizes:
vrs_sample_per_village <- vrsTidy %>% 
  group_by(question, vrs_island, vrs_village) %>%
  summarise(n = n(), n_blank = sum(response == "")) %>%
  mutate(all_blank = if_else(n_blank == n, true = "yes", false = "no")) 

write.csv(vrs_sample_per_village, "Outputs/vrs_sample_per_village.csv", row.names = FALSE)

# What if we remove all_blank==yes, all multi-select questions (whenever option = NA), and all fill-in-the-blank questions
vrs_sample_per_village_cleaned <- vrsTidy %>% 
  filter(is.na(option)) %>%
  filter(question %in% fill_in_questions == FALSE) %>%
  group_by(question, vrs_island, vrs_village) %>%
  summarise(n = n(), n_blank = sum(response == "")) %>%
  mutate(all_blank = if_else(n_blank == n, true = "yes", false = "no")) %>%
  filter(all_blank != "yes")

write.csv(vrs_sample_per_village_cleaned, "Outputs/vrs_sample_per_village_cleaned.csv", row.names = FALSE)


vrs_sample_per_island <- vrsTidy %>% 
  group_by(question, vrs_island) %>%
  summarise(n = n(), n_blank = sum(response == "")) %>%
  mutate(all_blank = if_else(n_blank == n, true = "yes", false = "no"))

write.csv(vrs_sample_per_island, "Outputs/vrs_sample_per_island.csv", row.names = FALSE)

vrs_sample_overall <- vrsTidy %>% 
  group_by(question) %>%
  summarise(n = n(), n_blank = sum(response == "")) %>%
  mutate(all_blank = if_else(n_blank == n, true = "yes", false = "no"))

write.csv(vrs_sample_overall, "Outputs/vrs_sample_overall.csv", row.names = FALSE)

# Output questions with zero answers for confirmation
vrs_no_responses <- vrsTidy %>% 
  group_by(question) %>%
  summarise(n = n(), n_blank = sum(response == "")) %>%
  mutate(all_blank = if_else(n_blank == n, true = "yes", false = "no")) %>%
  filter(all_blank == "yes")
  
write.csv(vrs_no_responses, "Outputs/vrs_no_responses.csv", row.names = FALSE)




  
```


## Event Roster Data: List of events



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean event roster 
#___________________________________________________________________________________________#


eventRoster <- read_dta(file.path(datadir, "VRS", "event_roster.dta"))

eventRoster <- clean_data(eventRoster)[[1]]

# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
eventRoster<- eventRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))

# Extract variable label attributes
var_labels <- clean_data(eventRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
eventRosterTidy <- tidy_data(df = eventRoster, pivot_col_1 = "event_occurrence", pivot_col_last = "event_nonfinfish", var_labels = var_labels, question_no = FALSE)

# Output question list
write.csv(unique(eventRosterTidy$question), "outputs/eventRoster_question_list.csv", row.names = FALSE)


# Clean responses for "Time of occurrence of event" should be years
eventRosterTidy <- eventRosterTidy %>%
  mutate(response = case_when(response == "0" ~ "2000",
                              response == "1" ~ "2001",
                              response == "2" ~ "2002",
                              response == "4" ~ "2004",
                              response == "7" ~ "2007",
                              response == "8" ~ "2008",
                              response == "10" ~ "2010",
                              TRUE ~ response))


write.csv(eventRosterTidy, "Outputs/eventRosterTidy.csv", row.names = FALSE)

event_subsets <- eventRosterTidy %>%
  select(event_roster__id) %>%
  unique()

event_subsets


```

## *Event: Coral bleaching*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Coral bleaching event")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20,incl_island = TRUE)

```


## *Event: Cyclone*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Cyclone")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Event: Harmful algal bloom*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Harmful algal bloom")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```

## *Event: Tsunami*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Tsunami")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```

## Fish Roster Data: List of fish assets

```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean fish roster
#___________________________________________________________________________________________#
fishassetRoster <- read_dta(file.path(datadir, "VRS", "fish_asset_roster.dta"))

fishassetRoster <- clean_data(fishassetRoster)[[1]]

# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
fishassetRoster<- fishassetRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))

# Extract variable label attributes
var_labels <- clean_data(fishassetRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fishassetRosterTidy <- tidy_data(df = fishassetRoster, pivot_col_1 = "num_assets", pivot_col_last = "num_assets10", var_labels = var_labels, question_no = FALSE)

write.csv(fishassetRosterTidy, "Outputs/fishassetRosterTidy.csv", row.names = FALSE)

# Output question list
write.csv(unique(fishassetRosterTidy$question), "outputs/fishassetRoster_question_list.csv", row.names = FALSE)



event_subsets <- fishassetRosterTidy %>%
  select(fish_asset_roster__id) %>%
  unique()

event_subsets
```
### *Asset: Fibreglass boats*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fibreglass boats")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```
## *Asset: Outboard Motors*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Outboard Motors")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Fishing Nets (gillnet)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (gillnet)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```

## *Asset: Spearguns*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Spearguns")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Fishing Lines*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Lines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)
```




## *Asset: Active Fish Traps*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets
plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Active Fish Traps")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)
```





## *Asset: Underwater flashlights*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Underwater flashlights")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)
```


## *Asset: Wood canoes*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Wood canoes")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: Eskies/portable coolers*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Eskies/portable coolers")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: SCUBA diving equipment*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "SCUBA diving equipment")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Freezers (electric or propane)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Freezers (electric or propane)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Ice machines*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Ice machines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Fishing Nets (purse)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (purse)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```

## *Asset: Drag Nets*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Drag Nets")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Harpoons/Spears*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Harpoons/Spears")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: FAD (Fish Aggregating Device)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "FAD (Fish Aggregating Device)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: Other Fishing Equipment (note)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Other Fishing Equipment (note)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)




```

## Outside Roster Data: List of outside assets



```{r, warning=FALSE}
#___________________________________________________________________________________________#
# Clean outside roster
#___________________________________________________________________________________________#
outsideRoster <- read_dta(file.path(datadir, "VRS", "outside_roster.dta"))

outsideRoster <- clean_data(outsideRoster)[[1]]

# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
outsideRoster<- outsideRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))

# Extract variable label attributes
var_labels <- clean_data(outsideRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
outsideRosterTidy <- tidy_data(df = outsideRoster, pivot_col_1 = "village_distance_out", pivot_col_last = "travel_time_out", var_labels = var_labels, question_no = FALSE)


write.csv(outsideRosterTidy, "Outputs/outsideRosterTidy.csv", row.names = FALSE)

# Output question list
write.csv(unique(outsideRosterTidy$question), "outputs/outsideRosterTidy_question_list.csv", row.names = FALSE)


# Output short answers
short_answers <- c("Other transport mode outside boundary", "Travel time outside boundary")
# Short answers - units need to be standardized and some responses need to be translated


# Output short answer responses for translation
other_answers <- outsideRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  filter((str_detect(response, pattern = "[[:alpha:]]") & str_detect(response, pattern = "[[:digit:]]"))==FALSE) %>% # filter out responses that are mixed alpha/digits (e.g., 1 minute) - unit already given
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/outsideRoster_other_answers.csv", row.names = FALSE)

#Filter out short answer responses before moving on to plotting data subsets
outsideRosterTidy <- outsideRosterTidy %>%
  filter(question %in% short_answers == FALSE)


event_subsets <- outsideRosterTidy %>%
  select(outside_roster__id) %>%
  unique()

event_subsets


```

## *Asset: Clinic/Hospital*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Clinic/Hospital")


# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Bank*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Bank") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset:  Nearest Market*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Market") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset:  Nearest Post Office*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Post Office") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```




## *Asset: Nearest Credit Facility*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Credit Facility") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```


## *Asset: Nearest Police Station*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Police Station") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```






## *Asset: Nearest Court House*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Court House") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```


## *Asset: Airport*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Airport") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```




## *Asset: Nearest Trade Store/Supermarket*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Trade Store/Supermarket") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```




## *Asset: Nearest fish landing site*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest fish landing site") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```





## *Asset: Nearest Church*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Church") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```



## Share Roster Data: List of events



```{r, warning = FALSE}
#___________________________________________________________________________________________#
# Clean share roster
#___________________________________________________________________________________________#
shareRoster <- read_dta(file.path(datadir, "VRS", "share_roster.dta"))

shareRoster <- clean_data(shareRoster)[[1]]

# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
shareRoster<- shareRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))

# Extract variable label attributes
var_labels <- clean_data(shareRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
shareRosterTidy <- tidy_data(df = shareRoster, pivot_col_1 = "catch_receiver__1", pivot_col_last = "share_other", var_labels = var_labels, question_no = FALSE)

write.csv(shareRosterTidy, "Outputs/shareRosterTidy.csv", row.names = FALSE)

# Output QUESTION list:
write.csv(unique(shareRosterTidy$question), "outputs/shareRoster_question_list.csv", row.names = FALSE)



# List short answer questions
short_answers <- c("Other giver of the sharing of catches", "Other receiver from the sharing of catches", "Other relationship from the sharing of catches",
                   "Other sharer of the catches")
# Short answers - units need to be standardized and some responses need to be translated

# Output short answer responses for translation
other_answers <- shareRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/shareRoster_other_answers.csv", row.names = FALSE)

# Filter out short answer responses before moving on to plotting data subsets
shareRosterTidy <- shareRosterTidy %>%
  filter(question %in% short_answers == FALSE)


event_subsets <- shareRosterTidy %>%
  select(share_roster__id) %>%
  unique()

event_subsets

```




## *Asset: Finfish*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Finfish")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response, incl_island = TRUE)


```



## *Asset: Other non-finfish seafood (shellfish, sea worm, etc.)*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Other non-finfish seafood (shellfish, sea worm, etc.)")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response, incl_island = TRUE)


```




## *Asset: Non-fish foods*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Non-fish foods")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response, incl_island = TRUE)


```



## VRS Roster Data: List of events



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean VRS roster
#___________________________________________________________________________________________#
vrsRoster <- read_dta(file.path(datadir, "VRS", "vrs_roster.dta"))

vrsRoster <- clean_data(vrsRoster)[[1]]

# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
vrsRoster<- vrsRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))


# Extract variable label attributes
var_labels <- clean_data(vrsRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))


# Make tidy
vrsRosterTidy <- tidy_data(df = vrsRoster, pivot_col_1 = "vrs_sex", pivot_col_last = "live_years", var_labels = var_labels, question_no = FALSE)

write.csv(vrsRosterTidy, "Outputs/vrsRosterTidy.csv", row.names = FALSE)


# Output QUESTION list:
write.csv(unique(vrsRosterTidy$question), "outputs/vrsRoster_question_list.csv", row.names = FALSE)


# List short answer questions
short_answers <- c("Other position of the respondent")
# Short answers - units need to be standardized and some responses need to be translated

# Output short answer responses for translation
other_answers <- vrsRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/vrsRoster_other_answers.csv", row.names = FALSE)


# Filter out short answer responses before moving on to plotting data subsets
vrsRosterTidy <- vrsRosterTidy %>%
  filter(question %in% short_answers == FALSE)


event_subsets <- vrsRosterTidy %>%
  select(vrs_roster__id) %>%
  unique()

event_subsets


```






## *VRS Roster: 1*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- vrsRosterTidy %>%
  filter(vrs_roster__id == "1") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)


```


## *VRS Roster: 2*
### Note: only contains one individual

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: VRS Roster 2 only contains one individual with the following characteristics

#vrsRosterTidy %>% filter(vrs_roster__id==2)


```

## Within Roster Data: List of events

```{r, warning = FALSE}

#___________________________________________________________________________________________#
# Clean within roster
#___________________________________________________________________________________________#
withinRoster <- read_dta(file.path(datadir, "VRS", "within_roster.dta"))

withinRoster <- clean_data(withinRoster)[[1]]


# Join back with vrsTidy to get island info
vrs_islands <- vrsTidy %>%
  select(interview__key, interview__id, vrs_island, vrs_village) %>%
  unique()
withinRoster<- withinRoster %>%
  left_join(vrs_islands, by = c("interview__key", "interview__id"))

# Extract variable label attributes
var_labels <- clean_data(withinRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
withinRosterTidy <- tidy_data(df = withinRoster, pivot_col_1 = "transport_mode_within", pivot_col_last = "travel_time_within", var_labels = var_labels, question_no = FALSE)

write.csv(withinRosterTidy, "Outputs/withinRosterTidy.csv", row.names = FALSE)


# Output QUESTION list:
write.csv(unique(withinRosterTidy$question), "outputs/withinRoster_question_list.csv", row.names = FALSE)

# List short answer questions:
short_answers <- c("Other transport mode within boundary", "Travel time within boundary")
# Short answers - units need to be standardized and some responses need to be translated

# Output short answer responses for translation
other_answers <- withinRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  filter((str_detect(response, pattern = "[[:alpha:]]") & str_detect(response, pattern = "[[:digit:]]"))==FALSE) %>% # filter out responses that are mixed alpha/digits (e.g., 1 minute) - unit already given
  unique() %>%
  arrange(question)

write.csv(other_answers, "Outputs/withinRoster_other_answers.csv", row.names = FALSE)

# Filter out short answer responses before moving on to plotting data subsets
withinRosterTidy <- withinRosterTidy %>%
  filter(question %in% short_answers == FALSE)

event_subsets <- withinRosterTidy %>%
  select(within_roster__id) %>%
  unique()

event_subsets



```





## *Asset: Nearest Church*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Church") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: Nearest Trade Store/Supermarket*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Trade Store/Supermarket") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Airport*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Airport") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Clinic/Hospital*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Clinic/Hospital") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Nearest fish landing site*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest fish landing site") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Asset: Nearest Credit Facility*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Credit Facility") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Nearest Market*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Market") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: Nearest Post Office*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Post Office") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```



## *Asset: Nearest Court House*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Court House") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```


## *Asset: Bank*

```{r, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Bank") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20, incl_island = TRUE)

```




## *Market survey*

```{r, warning=FALSE, message=FALSE, fig.height = 8, fig.width = 8,  results = 'asis'}
#___________________________________________________________________________________________#
# Clean market data
#___________________________________________________________________________________________#
market.files <- list.files("Data/HIES_raw_19May20/Market Survey")

# ID unique food items
food.files <- unique(gsub("_.*", '', market.files))
food.files <- food.files[food.files != "MarketSurvey.dta"]

food.items <- food.files
food.items[food.items == "veges"] <- "vege" # make singular (have to keep plural to read in file)

# Combine food and unit rosters
food.roster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", 
                                    paste(food.files[1], "roster.dta", sep ="_")))
unit.roster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", 
                                    paste(food.files[1], "unit", "roster.dta", sep ="_")))
# Standardize column names
colnames(food.roster) <- gsub(paste(food.items[1], "s", sep = ""), paste(food.items[1]), colnames(food.roster))
colnames(unit.roster) <- gsub(paste(food.items[1], "s", sep = ""), paste(food.items[1]), colnames(unit.roster))

# Merge by roster__id column (but not unit_roster__id column)
marketSurvey <- full_join(food.roster, unit.roster, by = c("interview__key", "interview__id", paste(food.items[1], "roster__id", sep ="_")))

# Clean and extract variable label attributes
marketSurvey <- clean_data(marketSurvey)[[1]]


# Remove y/n units columns and rename others
select.cols <- c("interview__key", "interview__id", 
                 paste(food.items[1], "roster__id", sep = "_"),
                 paste("other", food.items[1], "units", sep = "_"),
                 paste(food.items[1], "available", sep = "_"),
                 paste(food.items[1], "avail_oth", sep = "_"),
                 paste(food.items[1], "unit_roster__id", sep = "_"),
                 paste(food.items[1], "price", sep = "_"),
                 paste(food.items[1], "weight", sep = "_"),
                 paste(food.items[1], "unit_oth", sep = "_")
                 )
marketSurvey <- marketSurvey %>% 
  select_at(vars(select.cols))

# Standardize column names
colnames(marketSurvey) <- c("interview__key", "interview__id", "roster__id","other_units","availability","availability_other",
                            "unit_roster__id","price","weight", "unit_other")


for(i in 2:length(food.items)){
  food.roster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", 
                                    paste(food.files[i], "roster.dta", sep ="_")))
  unit.roster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", 
                                    paste(food.files[i], "unit", "roster.dta", sep ="_")))
  
  # Standardize column names
  colnames(food.roster) <- gsub(paste(food.items[i], "s", sep = ""), paste(food.items[i]), colnames(food.roster))
  colnames(unit.roster) <- gsub(paste(food.items[i], "s", sep = ""), paste(food.items[i]), colnames(unit.roster))

  # Merge by roster__id column (but not unit_roster__id column)
  food.unit.roster <- full_join(food.roster, unit.roster, by = c("interview__key", "interview__id", paste(food.items[i], "roster__id", sep ="_")))

  # Clean and extract variable label attributes
  food.unit.roster <- clean_data(food.unit.roster)[[1]]

  
  # Remove y/n units columns and rename others
  select.cols <- c("interview__key", "interview__id", 
                 paste(food.items[i], "roster__id", sep = "_"),
                 paste("other", food.items[i], "units", sep = "_"),
                 paste(food.items[i], "available", sep = "_"),
                 paste(food.items[i], "avail_oth", sep = "_"),
                 paste(food.items[i], "unit_roster__id", sep = "_"),
                 paste(food.items[i], "price", sep = "_"),
                 paste(food.items[i], "weight", sep = "_"),
                 paste(food.items[i], "unit_oth", sep = "_")
                 )
  food.unit.roster <- food.unit.roster %>% 
    select_at(vars(select.cols))

# Standardize column names
colnames(food.unit.roster) <- c("interview__key", "interview__id", "roster__id","other_units","availability","availability_other",
                            "unit_roster__id","price","weight", "unit_other")
  
  # Join with marketSurvey to create join all foods
  marketSurvey <- bind_rows(marketSurvey, food.unit.roster)
}

# Merge with survey location info
survey.info <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", "MarketSurvey.dta"))
survey.info <- clean_data(survey.info)[[1]]

survey.info <- survey.info %>%
  select("interview__key", "interview__id", "ms_island", "ms_village", "ea_market")

marketSurvey <- full_join(survey.info, marketSurvey, by = c("interview__key", "interview__id"))

write.csv(marketSurvey, file.path(outdir, "marketSurveyTidy.csv"), row.names=FALSE)


# Output sample sizes:
market_survey_sample_per_village <- marketSurvey %>% 
  group_by(ms_island, ms_village) %>%
  summarise(n_market = length(unique(ea_market)), n_foods = length(unique(roster__id)))

write.csv(market_survey_sample_per_village, file.path(outdir, "market_survey_sample_per_village.csv"), row.names=FALSE)


# Output short answer responses for translation
other_answers <- marketSurvey %>%
  filter(availability_other != "")

write.csv(other_answers, "Outputs/marketSurvey_other_answers.csv", row.names = FALSE)
  

# Plot food item availability
plot.food.availability(marketSurvey, incl_island = TRUE)

```






### Market survey continued... 
## Food prices

```{r, warning = FALSE, message = FALSE, fig.height = 8, results = 'asis'}

# Clean price data

# Question for Mike: why are their duplicates in price information within marketSurvey?
market_survey_price_duplicates <- marketSurvey %>% group_by(interview__id, roster__id, price, weight) %>% summarise(n=n()) %>% filter(n>1) %>% left_join(marketSurvey, by = c("interview__id", "roster__id", "price", "weight")) %>% ungroup() %>% select(-n) %>% arrange(interview__id)
write.csv(market_survey_price_duplicates, file = file.path(outdir, "market_survey_price_duplicates.csv"), row.names = FALSE) # n = 68


# FOODS WITH NO WEIGHT UNITS:
market_survey_no_weight_unit <- marketSurvey %>%
  mutate(unit_roster__id = as.character(unit_roster__id)) %>%
  filter(unit_roster__id %in% c("Bundle / Bunch / Pack", "Each / Piece", "Can / Bottle", "Box / Carton", "Bag", "Other units", "Bucket", "Plate / Bowl", "Basket") & is.na(unit_other))
write.csv(market_survey_no_weight_unit, file = file.path(outdir, "market_survey_no_weight_unit.csv"), row.names = FALSE) # n = 1

# FOODS WITH NO WEIGHT MEASUREMENT (usually things that are measured with unit_roster__id == Each/Piece usually also has an entry for weight and unit_other, but these do not)
market_survey_no_weight <- marketSurvey %>% 
  filter(weight ==0)
write.csv(market_survey_no_weight, file = file.path(outdir, "market_survey_no_weight.csv"), row.names = FALSE) # n = 17


# STANDARDIZE PRICES
market_survey_price <- marketSurvey %>% 
  group_by(interview__id, roster__id, price, weight) %>% 
  mutate(n=n()) %>% 
  arrange(desc(n)) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(-n) %>%
  arrange(interview__id) %>% 
  # Where it exists, use unit_other to replace unit_roster__id, but first mutate to character
  mutate(unit_roster__id = as.character(unit_roster__id),
         unit_other = as.character(unit_other)) %>%
  mutate(unit_roster__id = if_else(is.na(unit_other)==FALSE, true = unit_other, false = unit_roster__id)) %>%
  # Filter out foods with no weight units (n=1):
  filter(unit_roster__id != "Each / Piece") %>% 
  # Filter out foods with no weight measurements (n=17)
  filter(weight != 0) %>% 
  # Standardize FORMAT of units: (g) Grams vs grams (g) 
  mutate(unit_roster__id = case_when(unit_roster__id == "grams (g)" ~ "(g) Grams",
                                     unit_roster__id == "Pounds (lb)" ~ "(lbs) Pounds",
                                     unit_roster__id == "Kilograms (kg)" ~ "(kg) Kilograms",
                                     unit_roster__id == "(kg) Kilo-grams" ~ "(kg) Kilograms",
                                     TRUE ~ unit_roster__id)) %>%
  # Standardize units (first, standardize WITHIN metric and within US units)
  mutate(weight = if_else(unit_roster__id == "(kg) Kilograms", true = weight * 1000, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(kg) Kilograms", true = "(g) Grams", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(ml) Milliliters", true = weight / 1000, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(ml) Milliliters", true = "(ltr) Litres", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(lbs) Pounds", true = weight * 16, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(lbs) Pounds", true = "(oz) Ounces", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(c) Cups", true = weight / 16, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(c) Cups", true = "(gal) Gallons", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(pt) Pints", true = weight / 8, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(pt) Pints", true = "(gal) Gallons", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(qt) Quarts", true = weight / 4, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(qt) Quarts", true = "(gal) Gallons", false = unit_roster__id)) %>%
  # Standardize all to metric (convert ounces to grams, gallons to liters)
  mutate(weight = if_else(unit_roster__id == "(oz) Ounces", true = weight * 28.35, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(oz) Ounces", true = "(g) Grams", false = unit_roster__id)) %>%
  mutate(weight = if_else(unit_roster__id == "(gal) Gallons", true = weight * 3.78, false = weight),
         unit_roster__id = if_else(unit_roster__id == "(gal) Gallons", true = "(ltr) Litres", false = unit_roster__id)) %>%
  # Now calculate PRICE per UNIT WEIGHT
  mutate(standardized_price = price / weight)

# NOW PLOT:

plot.food.prices(market_survey_price, incl_island = TRUE)
  
# FOODS with mixed units: note, can get this list by allowing print(food) to run in plot.food.prices function
mixed_units <- c("Cordial, syrup, not further specified",
                 "Cooking oil &amp; fats",
                 "Canned meat, corned beef",
                 "Chocolate in bars or in slabs",
                 "Toffees, pastilles and other confectionery products",
                 "Other non alcoholic beverages",
                 "Noodles, pasta",
                 "Other diary and oil product",
                 "Brown coconut",
                 "Chewing gum",
                 "Ice block, icies, ice frubu etc",
                 "Chinese sweets (mango skin, pawpaw skin etc",
                 "Ice cream",
                 "Bottled water/spring water/mineral water",
                 "Cola flavour soft drink eg. Coca cola/Pepsi",
                 "Soft drinks (Fizzy), eg. Sprite, 7 Up, Tonic, Fanta,",
                 "Fruit juice (apple, pineapple, tropical etc...)",
                  "Lollies",
                 "Ice cream cones",
                 "Other fruit (specify)"
                 )


market_survey_diff_units <- market_survey_price %>%
  filter(roster__id %in% mixed_units) %>%
  arrange(roster__id)

write.csv(market_survey_diff_units, file = file.path(outdir, "market_survey_diff_units.csv"), row.names = FALSE)

