---
title: "Exploratory figures for CNHS"
author: "Kelvin Gorospe and Jessica Gephart"
date: "6/3/2020"
output: pdf_document
---


Notes for Mike:

* Where is the market availability data that we had in the last iteration?
* [name of product]_roster is the availability data
* What is the meaning of NA in the multiselect variable columns?
* "." and ".a" in STATA both mean missing. Refer to Mike's May 27 email for example (and to check for consistency with R)
* Why does VRS have household info and anemia info?
* Why are these output as different files (vrs, market, etc. each broken into multiple separate files)
* It is easiest to have the fewest number possible
* Are they going to translate the HIES iKiribati responses?
* Variable labels are cut off (how do we get the full answers back?) see: var_labels
* How to standardize units when none is given (e.g., question == Travel time outside boundary in outsideRoster dataset includes "12", "3", "30 minutes", "1 hour", etc)
* Is a response of "zero" the same as blank response? 

Suggested path forward:
 
1. Write out tidy versions of each data set and share csv
2. Write functions to visualize each question type:
     - Multi- and single-select, produce bar chart
     - Integer, produce bar chart
     - Continuous, produce histogram and (TBD: box and whisker)
     - Free response, compile unique answers with unique IDs for translation, question, island, possibly role
3. Loop through data and produce pdf of all plots
4. TBD: Start to creat summaries by village/island
 


```{r setup, echo = FALSE, warning = FALSE, message = FALSE}





knitr::opts_chunk$set(echo = FALSE)
library(haven)
library(tidyverse)
library(magrittr)
library(ggplot2)

#___________________________________________________________________________________________#
# Read in dta files
#___________________________________________________________________________________________#
datadir <- file.path(getwd(), "Data", "HIES_raw_19May20")
outdir <- file.path(getwd(), "Outputs")

source("R_scripts/cleaning_functions.R")
source("R_scripts/plotting_functions.R")

```

## Fisheries data
### *Multi-response questions*


```{r, warning = FALSE}

#___________________________________________________________________________________________#
# Clean fisheries data
#___________________________________________________________________________________________#
fisheries <- read_dta(file.path(datadir, "Fisheries", "Fisheries.dta"))


fisheries <- clean_data(fisheries)[[1]]

# Extract variable label attributes
var_labels <- clean_data(fisheries)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fisheriesTidy <- tidy_data(df = fisheries, pivot_col_1 = "sex", pivot_col_last = "p922n3", var_labels = var_labels, question_no = TRUE) # question_no = TRUE applies to fisheries data where col.labels includes a third column for question.no

write.csv(fisheriesTidy, "Outputs/fisheriesTidy.csv", row.names = FALSE)


#___________________________________________________________________________________________#
# Visualize fisheries data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- fisheriesTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")

plot_multi_response(plotDF_multiselect)


```


## Fisheries continued...
### *Single response questions*



```{r}

# List short-answer, fill-in response questions here:
fill_in_questions <- c("p903n", "p921n", "p922n1", "p922n2")

# Plot histogram for each single response question while removing zeroes
plotDF_single <- fisheriesTidy %>%
  filter(is.na(option)) %>%
  filter(question.no %in% fill_in_questions == FALSE) # remove "other" responses

plot_single_response(plotDF_single, bin_n = 20)
  

# Output short answer responses for translation
other_answers <- fisheriesTidy %>% 
  filter(question.no %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/fisheries_other_answers.csv", row.names = FALSE)




```

## VRS Data
### *Multi-response questions*



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean VRS data
#___________________________________________________________________________________________#
vrs <- read_dta(file.path(datadir, "VRS", "VRS.dta"))

vrs <- clean_data(vrs)[[1]]

# Extract variable label attributes
var_labels <- clean_data(vrs)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
vrsTidy <- tidy_data(df = vrs, pivot_col_1 = "vrs_island", pivot_col_last = "assignment__id", var_labels = var_labels, question_no = FALSE)

write.csv(vrsTidy, "Outputs/vrsTidy.csv", row.names = FALSE)


#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- vrsTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")


plot_multi_response(plotDF_multiselect)

```

## VRS continued...
### *Single response questions*


```{r}
# Plot histogram for each single response question while removing zeroes

# List short-answer, fill-in response questions here:
fill_in_questions <- vrsTidy %>%
  filter(str_detect(question, pattern = "Other")) %>% 
  pull(question) %>% 
  unique()

# Additional fill-in response questions:
fill_in_questions <- c(fill_in_questions, "Gender attending meeting", "Type of work the looking for", "New village rules")

# FIX IT - note: some short answers are still included in the single plots because they don't look too bad (e.g., "Year sewerage channel was introduced", Fee for connecting to sewage system); additional fill-in response questions are ID'ed based on eyeballing final plots

# FIX IT - confirm: assuming zero is different from "blank" (plotting function reports number of zeroes removed)
plotDF_single <- vrsTidy %>%
  filter(is.na(option)) %>%
  filter(question %in% fill_in_questions == FALSE)  %>% # remove all short answer questions 
  filter(response != "") %>% # If first response in a question set is blank, function plot_single_response does not work
  filter(question %in% c("VRS Village", "Household ID", "Start Time and Date for VRS section", "End Time and Date for VRS section",
                         "Errors count in the interview", "Status of the interview")==FALSE) # FIX IT - confirm: remove these too?

plot_single_response(plotDF_single, bin_n = 20)

# FIX IT, re-pivot so Village and/or Island are ID columns; use with color coding of scatterplots
# FIX IT, what is question = 50???
# FIX IT: how to deal with integers (bar plots) vs continuous (histogram): Number of people harvest from sea
#tmp_single <- plotDF_single %>% filter(question=="Number of people harvest from sea")
#typeof(as.numeric(tmp_single$response)) # recognized as double instead of integer

# Output short answer responses for translation
other_answers <- vrsTidy %>% 
  filter(question %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/vrs_other_answers.csv", row.names = FALSE)




  
```


## Event Roster Data: List of events



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean event roster 
#___________________________________________________________________________________________#
eventRoster <- read_dta(file.path(datadir, "VRS", "event_roster.dta"))

eventRoster <- clean_data(eventRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(eventRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
eventRosterTidy <- tidy_data(df = eventRoster, pivot_col_1 = "event_occurrence", pivot_col_last = "event_nonfinfish", var_labels = var_labels, question_no = FALSE)


# Clean responses for "Time of occurrence of event" should be years
eventRosterTidy <- eventRosterTidy %>%
  mutate(response = case_when(response == "0" ~ "2000",
                              response == "1" ~ "2001",
                              response == "2" ~ "2002",
                              response == "4" ~ "2004",
                              response == "7" ~ "2007",
                              response == "8" ~ "2008",
                              response == "10" ~ "2010",
                              TRUE ~ response))


write.csv(eventRosterTidy, "Outputs/eventRosterTidy.csv", row.names = FALSE)

event_subsets <- eventRosterTidy %>%
  select(event_roster__id) %>%
  unique()

event_subsets


```

## *Event: Coral bleaching*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Coral bleaching event")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Event: Cyclone*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Cyclone")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Event: Harmful algal bloom*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets


plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Harmful algal bloom")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

## *Event: Tsunami*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Tsunami")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

## Fish Roster Data: List of fish assets

```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean fish roster
#___________________________________________________________________________________________#
fishassetRoster <- read_dta(file.path(datadir, "VRS", "fish_asset_roster.dta"))

fishassetRoster <- clean_data(fishassetRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(fishassetRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fishassetRosterTidy <- tidy_data(df = fishassetRoster, pivot_col_1 = "num_assets", pivot_col_last = "num_assets10", var_labels = var_labels, question_no = FALSE)

write.csv(fishassetRosterTidy, "Outputs/fishassetRosterTidy.csv", row.names = FALSE)

event_subsets <- fishassetRosterTidy %>%
  select(fish_asset_roster__id) %>%
  unique()

event_subsets
```
### *Asset: Fibreglass boats*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fibreglass boats")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```
## *Asset: Outboard Motors*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Outboard Motors")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Fishing Nets (gillnet)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (gillnet)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

## *Asset: Spearguns*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Spearguns")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Fishing Lines*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Lines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```




## *Asset: Active Fish Traps*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets
plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Active Fish Traps")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```





## *Asset: Underwater flashlights*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Underwater flashlights")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```


## *Asset: Wood canoes*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Wood canoes")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: Eskies/portable coolers*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Eskies/portable coolers")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: SCUBA diving equipment*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "SCUBA diving equipment")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Freezers (electric or propane)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Freezers (electric or propane)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Ice machines*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Ice machines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Fishing Nets (purse)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (purse)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

## *Asset: Drag Nets*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Drag Nets")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Harpoons/Spears*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Harpoons/Spears")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: FAD (Fish Aggregating Device)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "FAD (Fish Aggregating Device)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: Other Fishing Equipment (note)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Other Fishing Equipment (note)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)




```

## Outside Roster Data: List of outside assets



```{r, warning=FALSE}
#___________________________________________________________________________________________#
# Clean outside roster
#___________________________________________________________________________________________#
outsideRoster <- read_dta(file.path(datadir, "VRS", "outside_roster.dta"))

outsideRoster <- clean_data(outsideRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(outsideRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
outsideRosterTidy <- tidy_data(df = outsideRoster, pivot_col_1 = "village_distance_out", pivot_col_last = "travel_time_out", var_labels = var_labels, question_no = FALSE)

# Filter out short answer responses before moving on to plotting data subsets
short_answers <- c("Other transport mode outside boundary", "Travel time outside boundary")
# Short answers - units need to be standardized and some responses need to be translated

outsideRosterTidy <- outsideRosterTidy %>%
  filter(question %in% short_answers == FALSE)

write.csv(outsideRosterTidy, "Outputs/outsideRosterTidy.csv", row.names = FALSE)


# Output short answer responses for translation
other_answers <- outsideRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/outsideRoster_other_answers.csv", row.names = FALSE)



event_subsets <- outsideRosterTidy %>%
  select(outside_roster__id) %>%
  unique()

event_subsets


```

## *Asset: Clinic/Hospital*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Clinic/Hospital")


# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Bank*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Bank") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset:  Nearest Market*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Market") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset:  Nearest Post Office*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Post Office") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```




## *Asset: Nearest Credit Facility*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Credit Facility") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```


## *Asset: Nearest Police Station*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Police Station") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```






## *Asset: Nearest Court House*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Court House") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```


## *Asset: Airport*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Airport") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```




## *Asset: Nearest Trade Store/Supermarket*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Trade Store/Supermarket") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```




## *Asset: Nearest fish landing site*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest fish landing site") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```





## *Asset: Nearest Church*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- outsideRosterTidy %>%
  filter(outside_roster__id == "Nearest Church") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```



## Share Roster Data: List of events



```{r, warning = FALSE}
shareRoster <- read_dta(file.path(datadir, "VRS", "share_roster.dta"))

#___________________________________________________________________________________________#
# Clean share roster
#___________________________________________________________________________________________#
shareRoster <- clean_data(shareRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(shareRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
shareRosterTidy <- tidy_data(df = shareRoster, pivot_col_1 = "catch_receiver__1", pivot_col_last = "share_other", var_labels = var_labels, question_no = FALSE)



# Filter out short answer responses before moving on to plotting data subsets
short_answers <- c("Other giver of the sharing of catches", "Other receiver from the sharing of catches", "Other relationship from the sharing of catches",
                   "Other sharer of the catches")
# Short answers - units need to be standardized and some responses need to be translated

shareRosterTidy <- shareRosterTidy %>%
  filter(question %in% short_answers == FALSE)

write.csv(shareRosterTidy, "Outputs/shareRosterTidy", row.names = FALSE)


# Output short answer responses for translation
other_answers <- shareRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/shareRoster_other_answers.csv", row.names = FALSE)



event_subsets <- shareRosterTidy %>%
  select(share_roster__id) %>%
  unique()

event_subsets

```




## *Asset: Finfish*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Finfish")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response)


```



## *Asset: Other non-finfish seafood (shellfish, sea worm, etc.)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Other non-finfish seafood (shellfish, sea worm, etc.)")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response)


```




## *Asset: Non-fish foods*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all MULTI-select questions: filter by event_subsets

plotDF_multiple_response <- shareRosterTidy %>%
  filter(share_roster__id == "Non-fish foods")  %>%
  filter(is.na(option)==FALSE) %>% # Removes all "shared individually or through institution" question - all blank
  filter(response == "1")


# Plot histogram
plot_multi_response(plotDF_multiple_response)


```



## VRS Roster Data: List of events



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean VRS roster
#___________________________________________________________________________________________#
vrsRoster <- read_dta(file.path(datadir, "VRS", "vrs_roster.dta"))

vrsRoster <- clean_data(vrsRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(vrsRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))


# Make tidy
vrsRosterTidy <- tidy_data(df = vrsRoster, pivot_col_1 = "vrs_sex", pivot_col_last = "live_years", var_labels = var_labels, question_no = FALSE)

# Filter out short answer responses before moving on to plotting data subsets
short_answers <- c("Other position of the respondent")
# Short answers - units need to be standardized and some responses need to be translated

vrsRosterTidy <- vrsRosterTidy %>%
  filter(question %in% short_answers == FALSE)


write.csv(vrsRosterTidy, "Outputs/vrsRosterTidy.csv", row.names = FALSE)


# Output short answer responses for translation
other_answers <- vrsRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/vrsRoster_other_answers.csv", row.names = FALSE)



event_subsets <- vrsRosterTidy %>%
  select(vrs_roster__id) %>%
  unique()

event_subsets


```






## *VRS Roster: 1*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- vrsRosterTidy %>%
  filter(vrs_roster__id == "1") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)


```


## *VRS Roster: 2*
### Note: only contains one individual with the following characteristics

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: VRS Roster 2 only contains one individual with the following characteristics

vrsRosterTidy %>% filter(vrs_roster__id==2)


```



```{r, warning = FALSE}

#___________________________________________________________________________________________#
# Clean within roster
#___________________________________________________________________________________________#
withinRoster <- read_dta(file.path(datadir, "VRS", "within_roster.dta"))

withinRoster <- clean_data(withinRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(withinRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
withinRosterTidy <- tidy_data(df = withinRoster, pivot_col_1 = "transport_mode_within", pivot_col_last = "travel_time_within", var_labels = var_labels, question_no = FALSE)

# Filter out short answer responses before moving on to plotting data subsets
short_answers <- c("Other transport mode within boundary", "Travel time within boundary")
# Short answers - units need to be standardized and some responses need to be translated


withinRosterTidy <- withinRosterTidy %>%
  filter(question %in% short_answers == FALSE)


write.csv(withinRosterTidy, "Outputs/withinRosterTidy.csv", row.names = FALSE)


# Output short answer responses for translation
other_answers <- withinRosterTidy %>% 
  filter(question %in% short_answers) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/withinRoster_other_answers.csv", row.names = FALSE)



event_subsets <- withinRosterTidy %>%
  select(within_roster__id) %>%
  unique()

event_subsets



```





## *Asset: Nearest Church*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Church") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: Nearest Trade Store/Supermarket*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Trade Store/Supermarket") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Airport*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Airport") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Clinic/Hospital*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Clinic/Hospital") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Nearest fish landing site*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest fish landing site") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




## *Asset: Nearest Credit Facility*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Credit Facility") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Nearest Market*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Market") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: Nearest Post Office*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Post Office") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



## *Asset: Nearest Court House*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Nearest Court House") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Asset: Bank*

```{r}
#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_subsets

plotDF_single <- withinRosterTidy %>%
  filter(within_roster__id == "Bank") 

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


## *Market survey*

```{r, warning=FALSE}
#___________________________________________________________________________________________#
# Clean market data
#___________________________________________________________________________________________#
market.files <- list.files("Data/HIES_raw_19May20/Market Survey")

# Identify each group of surveys
unit.roster.files <- market.files[grep("unit", market.files)]
food.roster.files <- market.files[grep("roster", market.files)]
food.roster.files <- food.roster.files[!(food.roster.files %in% unit.roster.files)]

# Join all unit rosters
unitRoster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", unit.roster.files[1]))
unitRoster <- clean_data(unitRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(unitRoster)[[2]]

# Make tidy
unitRoster <- tidy_data(df = unitRoster, pivot_col_1 = colnames(unitRoster)[3], pivot_col_last = colnames(unitRoster)[length(unitRoster)], var_labels = var_labels, question_no = FALSE)

for(i in 2:length(unit.roster.files)){
  df.rep <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", unit.roster.files[i]))
  df.rep <- clean_data(df.rep)[[1]]
  
  # Extract variable label attributes
  var_labels <- clean_data(df.rep)[[2]]
  # Make tidy
  df.rep <- tidy_data(df = df.rep, pivot_col_1 = colnames(df.rep)[3], pivot_col_last = colnames(df.rep)[length(colnames(df.rep))], var_labels = var_labels, question_no = FALSE)
  
  # Join all unit roster data
  unitRoster <- bind_rows(unitRoster, df.rep)
}


# Join all food rosters
foodRoster <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", food.roster.files[1]))
foodRoster <- clean_data(foodRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(foodRoster)[[2]]

# Make tidy
foodRoster <- tidy_data(df = foodRoster, pivot_col_1 = colnames(foodRoster)[4], pivot_col_last = colnames(foodRoster)[length(foodRoster)], var_labels = var_labels, question_no = FALSE)
colnames(foodRoster)[3] <- "roster__id"

for(i in 2:length(food.roster.files)){
  df.rep <- read_dta(file.path("Data", "HIES_raw_19May20", "Market Survey", food.roster.files[i]))
  df.rep <- clean_data(df.rep)[[1]]
  
  # Extract variable label attributes
  var_labels <- clean_data(df.rep)[[2]]
  # Make tidy
  df.rep <- tidy_data(df = df.rep, pivot_col_1 = colnames(df.rep)[4], pivot_col_last = colnames(df.rep)[length(colnames(df.rep))], var_labels = var_labels, question_no = FALSE)
  colnames(df.rep)[3] <- "roster__id"
  
  # Join all unit roster data
  foodRoster <- bind_rows(foodRoster, df.rep)
}

# Plot food item availability
plot.food.roster(foodRoster)

```

