---
title: "Exploratory figures for CNHS"
author: "Kelvin Gorospe and Jessica Gephart"
date: "6/3/2020"
output: html_document
---

```{r setup, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(haven)
library(tidyverse)
library(magrittr)
library(ggplot2)

#___________________________________________________________________________________________#
# Read in dta files
#___________________________________________________________________________________________#
datadir <- file.path(getwd(), "Data", "HIES_raw_19May20")
outdir <- file.path(getwd(), "Outputs")

source("R_scripts/cleaning_functions.R")
source("R_scripts/plotting_functions.R")

```

## Fisheries data
### *Multi-response questions*


```{r, warning = FALSE}

#___________________________________________________________________________________________#
# Clean fisheries data
#___________________________________________________________________________________________#
fisheries <- read_dta(file.path(datadir, "Fisheries", "Fisheries.dta"))


fisheries <- clean_data(fisheries)[[1]]

# Extract variable label attributes
var_labels <- clean_data(fisheries)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fisheriesTidy <- tidy_data(df = fisheries, pivot_col_1 = "sex", pivot_col_last = "p922n3", var_labels = var_labels, question_no = TRUE) # question_no = TRUE applies to fisheries data where col.labels includes a third column for question.no

write.csv(fisheriesTidy, "Outputs/fisheriesTidy.csv", row.names = FALSE)


#___________________________________________________________________________________________#
# Visualize fisheries data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- fisheriesTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")

plot_multi_response(plotDF_multiselect)


```


## Fisheries continued...
### *Single response questions*



```{r}

# List short-answer, fill-in response questions here:
fill_in_questions <- c("p903n", "p921n", "p922n1", "p922n2")

# Plot histogram for each single response question while removing zeroes
plotDF_single <- fisheriesTidy %>%
  filter(is.na(option)) %>%
  filter(question.no %in% fill_in_questions == FALSE) # remove "other" responses

plot_single_response(plotDF_single, bin_n = 20)
  

# Output short answer responses for translation
other_answers <- fisheriesTidy %>% 
  filter(question.no %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/fisheries_other_answers.csv", row.names = FALSE)




```

## VRS Data
### *Multi-response questions*



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean VRS data
#___________________________________________________________________________________________#
vrs <- read_dta(file.path(datadir, "VRS", "VRS.dta"))

vrs <- clean_data(vrs)[[1]]

# Extract variable label attributes
var_labels <- clean_data(vrs)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
vrsTidy <- tidy_data(df = vrs, pivot_col_1 = "vrs_island", pivot_col_last = "assignment__id", var_labels = var_labels, question_no = FALSE)

write.csv(vrsTidy, "Outputs/vrsTidy.csv", row.names = FALSE)


#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Bar graphs and Histograms of single/multi-select questions


# Plot bar graph for each multi-select question
plotDF_multiselect <- vrsTidy %>%
  filter(!is.na(option)) %>%
  filter(response == "1")


plot_multi_response(plotDF_multiselect)

```

## VRS continued...
### *Single response questions*


```{r}
# Plot histogram for each single response question while removing zeroes

# List short-answer, fill-in response questions here:
fill_in_questions <- vrsTidy %>%
  filter(str_detect(question, pattern = "Other")) %>% 
  pull(question) %>% 
  unique()

# Additional fill-in response questions:
fill_in_questions <- c(fill_in_questions, "Gender attending meeting", "Type of work the looking for", "New village rules")

# FIX IT - note: some short answers are still included in the single plots because they don't look too bad (e.g., "Year sewerage channel was introduced", Fee for connecting to sewage system); additional fill-in response questions are ID'ed based on eyeballing final plots

# FIX IT - confirm: assuming zero is different from "blank" (plotting function reports number of zeroes removed)
plotDF_single <- vrsTidy %>%
  filter(is.na(option)) %>%
  filter(question %in% fill_in_questions == FALSE)  %>% # remove all short answer questions 
  filter(response != "") %>% # If first response in a question set is blank, function plot_single_response does not work
  filter(question %in% c("VRS Village", "Household ID", "Start Time and Date for VRS section", "End Time and Date for VRS section",
                         "Errors count in the interview", "Status of the interview")==FALSE) # FIX IT - confirm: remove these too?

plot_single_response(plotDF_single, bin_n = 20)

# FIX IT, re-pivot so Village and/or Island are ID columns; use with color coding of scatterplots
# FIX IT, what is question = 50???
# FIX IT: how to deal with integers (bar plots) vs continuous (histogram): Number of people harvest from sea
#tmp_single <- plotDF_single %>% filter(question=="Number of people harvest from sea")
#typeof(as.numeric(tmp_single$response)) # recognized as double instead of integer

# Output short answer responses for translation
other_answers <- vrsTidy %>% 
  filter(question %in% fill_in_questions) %>%
  filter(response != "") %>% 
  unique()

write.csv(other_answers, "Outputs/vrs_other_answers.csv", row.names = FALSE)




  
```


## Event Roster Data: List of events



```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean event roster 
#___________________________________________________________________________________________#
eventRoster <- read_dta(file.path(datadir, "VRS", "event_roster.dta"))

eventRoster <- clean_data(eventRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(eventRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
eventRosterTidy <- tidy_data(df = eventRoster, pivot_col_1 = "event_occurrence", pivot_col_last = "event_nonfinfish", var_labels = var_labels, question_no = FALSE)


# Clean responses for "Time of occurrence of event" should be years
eventRosterTidy <- eventRosterTidy %>%
  mutate(response = case_when(response == "0" ~ "2000",
                              response == "1" ~ "2001",
                              response == "2" ~ "2002",
                              response == "4" ~ "2004",
                              response == "7" ~ "2007",
                              response == "8" ~ "2008",
                              response == "10" ~ "2010",
                              TRUE ~ response))


write.csv(eventRosterTidy, "Outputs/eventRosterTidy.csv", row.names = FALSE)

event_subsets <- eventRosterTidy %>%
  select(event_roster__id) %>%
  unique()

event_subsets


```

# *Event: Coral bleaching*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all single-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Coral bleaching event")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


*Event: Cyclone*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Cyclone")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


*Event: Harmful algal bloom*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id


plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Harmful algal bloom")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

*Event: Tsunami*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- eventRosterTidy %>%
  filter(event_roster__id == "Tsunami")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

## Fish Roster Data: List of fish assets

```{r, warning=FALSE}

#___________________________________________________________________________________________#
# Clean fish roster
#___________________________________________________________________________________________#
fishassetRoster <- read_dta(file.path(datadir, "VRS", "fish_asset_roster.dta"))

fishassetRoster <- clean_data(fishassetRoster)[[1]]

# Extract variable label attributes
var_labels <- clean_data(fishassetRoster)[[2]]

# Change class to character to allow left_join without warning below
var_labels <- var_labels %>%
  mutate(col.names = as.character(col.names))

# Make tidy
fishassetRosterTidy <- tidy_data(df = fishassetRoster, pivot_col_1 = "num_assets", pivot_col_last = "num_assets10", var_labels = var_labels, question_no = FALSE)

write.csv(fishassetRosterTidy, "Outputs/fishassetRosterTidy.csv", row.names = FALSE)

event_subsets <- fishassetRosterTidy %>%
  select(fish_asset_roster__id) %>%
  unique()

event_subsets
```
*Asset: Fibreglass boats*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fibreglass boats")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```
*Asset: Outboard Motors*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Outboard Motors")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




*Asset: Fishing Nets (gillnet)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (gillnet)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

*Asset: Spearguns*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Spearguns")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




*Asset: Fishing Lines*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Lines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```




*Asset: Active Fish Traps*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Active Fish Traps")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```





*Asset: Underwater flashlights*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Underwater flashlights")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)
```


*Asset: Wood canoes*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Wood canoes")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


*Asset: Eskies/portable coolers*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Eskies/portable coolers")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




*Asset: SCUBA diving equipment*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "SCUBA diving equipment")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



*Asset: Freezers (electric or propane)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Freezers (electric or propane)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




*Asset: Ice machines*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Ice machines")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```




*Asset: Fishing Nets (purse)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Fishing Nets (purse)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```

*Asset: Drag Nets*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Drag Nets")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```



*Asset: Harpoons/Spears*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Harpoons/Spears")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


*Asset: FAD (Fish Aggregating Device)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "FAD (Fish Aggregating Device)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)

```


*Asset: Other Fishing Equipment (note)*

```{r}

#___________________________________________________________________________________________#
# Visualize data
#___________________________________________________________________________________________#
# Note: Roster is all multi-select questions: no filtering needed; subset by event_roster__id

plotDF_single <- fishassetRosterTidy %>%
  filter(fish_asset_roster__id == "Other Fishing Equipment (note)")

# Plot histogram
plot_single_response(plotDF_single, bin_n = 20)




```
